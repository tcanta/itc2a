
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>A higher level definition of the bytecode interpreter &#8212; Informatique de Tonc Commun 2A La Martin</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'payloads/payload1/Python-3.13.0rc2/Tools/cases_generator/interpreter_definition';</script>
    <link rel="icon" href="../../../../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../../../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../../../_static/logo.png" class="logo__image only-light" alt="Informatique de Tonc Commun 2A La Martin - Home"/>
    <script>document.write(`<img src="../../../../../_static/logo.png" class="logo__image only-dark" alt="Informatique de Tonc Commun 2A La Martin - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../../../intro.html">
                    Informatique de Tronc Commun spé
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Révisions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../../tp/tp_revisions.html">TP: Révisions de 1ère année</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Structures de Données</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../../../cours/cours_structures.html">Cours: Dictionnaires et ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../td/dict_polynome.html">TD: Polynôme et dictionnaire</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tp/tp_structures.html">TP: Dictionnaires</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/tcanta/itc2a" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/tcanta/itc2a/issues/new?title=Issue%20on%20page%20%2Fpayloads/payload1/Python-3.13.0rc2/Tools/cases_generator/interpreter_definition.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../../../_sources/payloads/payload1/Python-3.13.0rc2/Tools/cases_generator/interpreter_definition.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>A higher level definition of the bytecode interpreter</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#abstract">Abstract</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rationale">Rationale</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#specification">Specification</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax">Syntax</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#special-instruction-annotations">Special instruction annotations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#special-functions-macros">Special functions/macros</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#semantics">Semantics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examples">Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output-stack-effect">Output stack effect</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-stack-effect">Input stack effect</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-stack-effect-and-cache-effect">Input stack effect and cache effect</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#more-examples">More examples</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-an-instruction-family">Defining an instruction family</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-a-pseudo-instruction">Defining a pseudo instruction</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-the-interpreter">Generating the interpreter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-tools">Other tools</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="a-higher-level-definition-of-the-bytecode-interpreter">
<h1>A higher level definition of the bytecode interpreter<a class="headerlink" href="#a-higher-level-definition-of-the-bytecode-interpreter" title="Link to this heading">#</a></h1>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Link to this heading">#</a></h2>
<p>The CPython interpreter is defined in C, meaning that the semantics of the
bytecode instructions, the dispatching mechanism, error handling, and
tracing and instrumentation are all intermixed.</p>
<p>This document proposes defining a custom C-like DSL for defining the
instruction semantics and tools for generating the code deriving from
the instruction definitions.</p>
<p>These tools would be used to:</p>
<ul class="simple">
<li><p>Generate the main interpreter (done)</p></li>
<li><p>Generate the tier 2 interpreter</p></li>
<li><p>Generate documentation for instructions</p></li>
<li><p>Generate metadata about instructions, such as stack use (done).</p></li>
<li><p>Generate the tier 2 optimizer’s abstract interpreter.</p></li>
</ul>
<p>Having a single definition file ensures that there is a single source
of truth for bytecode semantics.</p>
<p>Other tools that operate on bytecodes, like <code class="docutils literal notranslate"><span class="pre">frame.setlineno</span></code>
and the <code class="docutils literal notranslate"><span class="pre">dis</span></code> module, will be derived from the common semantic
definition, reducing errors.</p>
</section>
<section id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Link to this heading">#</a></h2>
<p>The bytecode interpreter of CPython has traditionally been defined as standard
C code, but with a lot of macros.
The presence of these macros and the nature of bytecode interpreters means
that the interpreter is effectively defined in a domain specific language (DSL).</p>
<p>Rather than using an ad-hoc DSL embedded in the C code for the interpreter,
a custom DSL should be defined and the semantics of the bytecode instructions,
and the instructions defined in that DSL.</p>
<p>Generating the interpreter decouples low-level details of dispatching
and error handling from the semantics of the instructions, resulting
in more maintainable code and a potentially faster interpreter.</p>
<p>It also provides the ability to create and check optimizers and optimization
passes from the semantic definition, reducing errors.</p>
</section>
<section id="rationale">
<h2>Rationale<a class="headerlink" href="#rationale" title="Link to this heading">#</a></h2>
<p>As we improve the performance of CPython, we need to optimize larger regions
of code, use more complex optimizations and, ultimately, translate to machine
code.</p>
<p>All of these steps introduce the possibility of more bugs, and require more code
to be written. One way to mitigate this is through the use of code generators.
Code generators decouple the debugging of the code (the generator) from checking
the correctness (the DSL input).</p>
<p>For example, we are likely to want a new interpreter for the tier 2 optimizer
to be added in 3.12. That interpreter will have a different API, a different
set of instructions and potentially different dispatching mechanism.
But the instructions it will interpret will be built from the same building
blocks as the instructions for the tier 1 (PEP 659) interpreter.</p>
<p>Rewriting all the instructions is tedious and error-prone, and changing the
instructions is a maintenance headache as both versions need to be kept in sync.</p>
<p>By using a code generator and using a common source for the instructions, or
parts of instructions, we can reduce the potential for errors considerably.</p>
</section>
<section id="specification">
<h2>Specification<a class="headerlink" href="#specification" title="Link to this heading">#</a></h2>
<p>This specification is a work in progress.
We update it as the need arises.</p>
<section id="syntax">
<h3>Syntax<a class="headerlink" href="#syntax" title="Link to this heading">#</a></h3>
<p>Each op definition has a kind, a name, a stack and instruction stream effect,
and a piece of C code describing its semantics::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">file</span><span class="p">:</span>
    <span class="p">(</span><span class="n">definition</span> <span class="o">|</span> <span class="n">family</span> <span class="o">|</span> <span class="n">pseudo</span><span class="p">)</span><span class="o">+</span>

  <span class="n">definition</span><span class="p">:</span>
    <span class="s2">&quot;inst&quot;</span> <span class="s2">&quot;(&quot;</span> <span class="n">NAME</span> <span class="p">[</span><span class="s2">&quot;,&quot;</span> <span class="n">stack_effect</span><span class="p">]</span> <span class="s2">&quot;)&quot;</span> <span class="s2">&quot;{&quot;</span> <span class="n">C</span><span class="o">-</span><span class="n">code</span> <span class="s2">&quot;}&quot;</span>
    <span class="o">|</span>
    <span class="s2">&quot;op&quot;</span> <span class="s2">&quot;(&quot;</span> <span class="n">NAME</span> <span class="s2">&quot;,&quot;</span> <span class="n">stack_effect</span> <span class="s2">&quot;)&quot;</span> <span class="s2">&quot;{&quot;</span> <span class="n">C</span><span class="o">-</span><span class="n">code</span> <span class="s2">&quot;}&quot;</span>
    <span class="o">|</span>
    <span class="s2">&quot;macro&quot;</span> <span class="s2">&quot;(&quot;</span> <span class="n">NAME</span> <span class="s2">&quot;)&quot;</span> <span class="s2">&quot;=&quot;</span> <span class="n">uop</span> <span class="p">(</span><span class="s2">&quot;+&quot;</span> <span class="n">uop</span><span class="p">)</span><span class="o">*</span> <span class="s2">&quot;;&quot;</span>

  <span class="n">stack_effect</span><span class="p">:</span>
    <span class="s2">&quot;(&quot;</span> <span class="p">[</span><span class="n">inputs</span><span class="p">]</span> <span class="s2">&quot;--&quot;</span> <span class="p">[</span><span class="n">outputs</span><span class="p">]</span> <span class="s2">&quot;)&quot;</span>

  <span class="n">inputs</span><span class="p">:</span>
    <span class="nb">input</span> <span class="p">(</span><span class="s2">&quot;,&quot;</span> <span class="nb">input</span><span class="p">)</span><span class="o">*</span>

  <span class="n">outputs</span><span class="p">:</span>
    <span class="n">output</span> <span class="p">(</span><span class="s2">&quot;,&quot;</span> <span class="n">output</span><span class="p">)</span><span class="o">*</span>

  <span class="nb">input</span><span class="p">:</span>
    <span class="nb">object</span> <span class="o">|</span> <span class="n">stream</span> <span class="o">|</span> <span class="n">array</span>

  <span class="n">output</span><span class="p">:</span>
    <span class="nb">object</span> <span class="o">|</span> <span class="n">array</span>

  <span class="n">uop</span><span class="p">:</span>
    <span class="n">NAME</span> <span class="o">|</span> <span class="n">stream</span>

  <span class="nb">object</span><span class="p">:</span>
    <span class="n">NAME</span> <span class="p">[</span><span class="s2">&quot;:&quot;</span> <span class="nb">type</span><span class="p">]</span> <span class="p">[</span> <span class="s2">&quot;if&quot;</span> <span class="s2">&quot;(&quot;</span> <span class="n">C</span><span class="o">-</span><span class="n">expression</span> <span class="s2">&quot;)&quot;</span> <span class="p">]</span>

  <span class="nb">type</span><span class="p">:</span>
    <span class="n">NAME</span> <span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span>

  <span class="n">stream</span><span class="p">:</span>
    <span class="n">NAME</span> <span class="s2">&quot;/&quot;</span> <span class="n">size</span>

  <span class="n">size</span><span class="p">:</span>
    <span class="n">INTEGER</span>

  <span class="n">array</span><span class="p">:</span>
    <span class="nb">object</span> <span class="s2">&quot;[&quot;</span> <span class="n">C</span><span class="o">-</span><span class="n">expression</span> <span class="s2">&quot;]&quot;</span>

  <span class="n">family</span><span class="p">:</span>
    <span class="s2">&quot;family&quot;</span> <span class="s2">&quot;(&quot;</span> <span class="n">NAME</span> <span class="s2">&quot;)&quot;</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="n">NAME</span> <span class="p">(</span><span class="s2">&quot;,&quot;</span> <span class="n">NAME</span><span class="p">)</span><span class="o">+</span> <span class="p">[</span><span class="s2">&quot;,&quot;</span><span class="p">]</span> <span class="s2">&quot;}&quot;</span> <span class="s2">&quot;;&quot;</span>

  <span class="n">pseudo</span><span class="p">:</span>
    <span class="s2">&quot;pseudo&quot;</span> <span class="s2">&quot;(&quot;</span> <span class="n">NAME</span> <span class="s2">&quot;)&quot;</span> <span class="o">=</span> <span class="s2">&quot;{&quot;</span> <span class="n">NAME</span> <span class="p">(</span><span class="s2">&quot;,&quot;</span> <span class="n">NAME</span><span class="p">)</span><span class="o">+</span> <span class="p">[</span><span class="s2">&quot;,&quot;</span><span class="p">]</span> <span class="s2">&quot;}&quot;</span> <span class="s2">&quot;;&quot;</span>
</pre></div>
</div>
<p>The following definitions may occur:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">inst</span></code>: A normal instruction, as previously defined by <code class="docutils literal notranslate"><span class="pre">TARGET(NAME)</span></code> in <code class="docutils literal notranslate"><span class="pre">ceval.c</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">op</span></code>: A part instruction from which macros can be constructed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">macro</span></code>: A bytecode instruction constructed from ops and cache effects.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">NAME</span></code> can be any ASCII identifier that is a C identifier and not a C or Python keyword.
<code class="docutils literal notranslate"><span class="pre">foo_1</span></code> is legal. <code class="docutils literal notranslate"><span class="pre">$</span></code> is not legal, nor is <code class="docutils literal notranslate"><span class="pre">struct</span></code> or <code class="docutils literal notranslate"><span class="pre">class</span></code>.</p>
<p>The optional <code class="docutils literal notranslate"><span class="pre">type</span></code> in an <code class="docutils literal notranslate"><span class="pre">object</span></code> is the C type. It defaults to <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code>.
The objects before the “–” are the objects on top of the stack at the start of
the instruction. Those after the “–” are the objects on top of the stack at the
end of the instruction.</p>
<p>An <code class="docutils literal notranslate"><span class="pre">inst</span></code> without <code class="docutils literal notranslate"><span class="pre">stack_effect</span></code> is a transitional form to allow the original C code
definitions to be copied. It lacks information to generate anything other than the
interpreter, but is useful for initial porting of code.</p>
<p>Stack effect names may be <code class="docutils literal notranslate"><span class="pre">unused</span></code>, indicating the space is to be reserved
but no use of it will be made in the instruction definition.
This is useful to ensure that all instructions in a family have the same
stack effect.</p>
<p>The number in a <code class="docutils literal notranslate"><span class="pre">stream</span></code> define how many codeunits are consumed from the
instruction stream. It returns a 16, 32 or 64 bit value.
If the name is <code class="docutils literal notranslate"><span class="pre">unused</span></code> the size can be any value and that many codeunits
will be skipped in the instruction stream.</p>
<p>By convention cache effects (<code class="docutils literal notranslate"><span class="pre">stream</span></code>) must precede the input effects.</p>
<p>The name <code class="docutils literal notranslate"><span class="pre">oparg</span></code> is pre-defined as a 32 bit value fetched from the instruction stream.</p>
</section>
<section id="special-instruction-annotations">
<h3>Special instruction annotations<a class="headerlink" href="#special-instruction-annotations" title="Link to this heading">#</a></h3>
<p>Instruction headers may be prefixed by one or more annotations. The non-exhaustive
list of annotations and their meanings are as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">override</span></code>. For external use by other interpreter definitions to override the current
instruction definition.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pure</span></code>. This instruction has no side effects.</p></li>
<li><p>‘tierN’. This instruction only used by tier N interpreter.</p></li>
</ul>
</section>
<section id="special-functions-macros">
<h3>Special functions/macros<a class="headerlink" href="#special-functions-macros" title="Link to this heading">#</a></h3>
<p>The C code may include special functions that are understood by the tools as
part of the DSL.</p>
<p>Those functions include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DEOPT_IF(cond,</span> <span class="pre">instruction)</span></code>. Deoptimize if <code class="docutils literal notranslate"><span class="pre">cond</span></code> is met.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERROR_IF(cond,</span> <span class="pre">label)</span></code>. Jump to error handler at <code class="docutils literal notranslate"><span class="pre">label</span></code> if <code class="docutils literal notranslate"><span class="pre">cond</span></code> is true.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DECREF_INPUTS()</span></code>. Generate <code class="docutils literal notranslate"><span class="pre">Py_DECREF()</span></code> calls for the input stack effects.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SYNC_SP()</span></code>. Synchronizes the physical stack pointer with the stack effects.</p></li>
</ul>
<p>Note that the use of <code class="docutils literal notranslate"><span class="pre">DECREF_INPUTS()</span></code> is optional – manual calls
to <code class="docutils literal notranslate"><span class="pre">Py_DECREF()</span></code> or other approaches are also acceptable
(e.g. calling an API that “steals” a reference).</p>
<p>Variables can either be defined in the input, output, or in the C code.
Variables defined in the input may not be assigned in the C code.
If an <code class="docutils literal notranslate"><span class="pre">ERROR_IF</span></code> occurs, all values will be removed from the stack;
they must already be <code class="docutils literal notranslate"><span class="pre">DECREF</span></code>’ed by the code block.
If a <code class="docutils literal notranslate"><span class="pre">DEOPT_IF</span></code> occurs, no values will be removed from the stack or
the instruction stream; no values must have been <code class="docutils literal notranslate"><span class="pre">DECREF</span></code>’ed or created.</p>
<p>These requirements result in the following constraints on the use of
<code class="docutils literal notranslate"><span class="pre">DEOPT_IF</span></code> and <code class="docutils literal notranslate"><span class="pre">ERROR_IF</span></code> in any instruction’s code block:</p>
<ol class="arabic simple">
<li><p>Until the last <code class="docutils literal notranslate"><span class="pre">DEOPT_IF</span></code>, no objects may be allocated, <code class="docutils literal notranslate"><span class="pre">INCREF</span></code>ed,
or <code class="docutils literal notranslate"><span class="pre">DECREF</span></code>ed.</p></li>
<li><p>Before the first <code class="docutils literal notranslate"><span class="pre">ERROR_IF</span></code>, all input values must be <code class="docutils literal notranslate"><span class="pre">DECREF</span></code>ed,
and no objects may be allocated or <code class="docutils literal notranslate"><span class="pre">INCREF</span></code>ed, with the exception
of attempting to create an object and checking for success using
<code class="docutils literal notranslate"><span class="pre">ERROR_IF(result</span> <span class="pre">==</span> <span class="pre">NULL,</span> <span class="pre">label)</span></code>. (TODO: Unclear what to do with
intermediate results.)</p></li>
<li><p>No <code class="docutils literal notranslate"><span class="pre">DEOPT_IF</span></code> may follow an <code class="docutils literal notranslate"><span class="pre">ERROR_IF</span></code> in the same block.</p></li>
</ol>
<p>(There is some wiggle room: these rules apply to dynamic code paths,
not to static occurrences in the source code.)</p>
<p>If code detects an error condition before the first <code class="docutils literal notranslate"><span class="pre">DECREF</span></code> of an input,
two idioms are valid:</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">goto</span> <span class="pre">error</span></code>.</p></li>
<li><p>Use a block containing the appropriate <code class="docutils literal notranslate"><span class="pre">DECREF</span></code> calls ending in
<code class="docutils literal notranslate"><span class="pre">ERROR_IF(true,</span> <span class="pre">error)</span></code>.</p></li>
</ul>
<p>An example of the latter would be:</p>
<div class="highlight-cc notranslate"><div class="highlight"><pre><span></span>    res = PyObject_Add(left, right);
    if (res == NULL) {
        DECREF_INPUTS();
        ERROR_IF(true, error);
    }
</pre></div>
</div>
</section>
<section id="semantics">
<h3>Semantics<a class="headerlink" href="#semantics" title="Link to this heading">#</a></h3>
<p>The underlying execution model is a stack machine.
Operations pop values from the stack, and push values to the stack.
They also can look at, and consume, values from the instruction stream.</p>
<p>All members of a family
(which represents a specializable instruction and its specializations)
must have the same stack and instruction stream effect.</p>
<p>The same is true for all members of a pseudo instruction
(which is mapped by the bytecode compiler to one of its members).</p>
</section>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Link to this heading">#</a></h2>
<p>(Another source of examples can be found in the <a class="reference internal" href="#test_generator.py"><span class="xref myst">tests</span></a>.)</p>
<p>Some examples:</p>
<section id="output-stack-effect">
<h3>Output stack effect<a class="headerlink" href="#output-stack-effect" title="Link to this heading">#</a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">inst</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">LOAD_FAST</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">--</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">f_localsplus</span><span class="p">[</span><span class="n">oparg</span><span class="p">];</span>
<span class="w">        </span><span class="n">Py_INCREF</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>This would generate:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">TARGET</span><span class="p">(</span><span class="n">LOAD_FAST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="p">;</span>
<span class="w">        </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">f_localsplus</span><span class="p">[</span><span class="n">oparg</span><span class="p">];</span>
<span class="w">        </span><span class="n">Py_INCREF</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="n">PUSH</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="n">DISPATCH</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="input-stack-effect">
<h3>Input stack effect<a class="headerlink" href="#input-stack-effect" title="Link to this heading">#</a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">inst</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">STORE_FAST</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SETLOCAL</span><span class="p">(</span><span class="n">oparg</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>This would generate:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">TARGET</span><span class="p">(</span><span class="n">STORE_FAST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PEEK</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">SETLOCAL</span><span class="p">(</span><span class="n">oparg</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="n">STACK_SHRINK</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">DISPATCH</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="input-stack-effect-and-cache-effect">
<h3>Input stack effect and cache effect<a class="headerlink" href="#input-stack-effect-and-cache-effect" title="Link to this heading">#</a></h3>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CHECK_OBJECT_TYPE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">type_version</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">owner</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">PyTypeObject</span><span class="w"> </span><span class="o">*</span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Py_TYPE</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">type_version</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">DEOPT_IF</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_version_tag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">type_version</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>This might become (if it was an instruction):</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">TARGET</span><span class="p">(</span><span class="n">CHECK_OBJECT_TYPE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PEEK</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="n">uint32</span><span class="w"> </span><span class="n">type_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read32</span><span class="p">(</span><span class="n">next_instr</span><span class="p">);</span>
<span class="w">        </span><span class="n">PyTypeObject</span><span class="w"> </span><span class="o">*</span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Py_TYPE</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">type_version</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">DEOPT_IF</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_version_tag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">type_version</span><span class="p">);</span>
<span class="w">        </span><span class="n">next_instr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">        </span><span class="n">DISPATCH</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="more-examples">
<h3>More examples<a class="headerlink" href="#more-examples" title="Link to this heading">#</a></h3>
<p>For explanations see “Generating the interpreter” below.)</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CHECK_HAS_INSTANCE_VALUES</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">owner</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">owner</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">PyDictOrValues</span><span class="w"> </span><span class="n">dorv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">_PyObject_DictOrValuesPointer</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="w">        </span><span class="n">DEOPT_IF</span><span class="p">(</span><span class="o">!</span><span class="n">_PyDictOrValues_IsValues</span><span class="p">(</span><span class="n">dorv</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">LOAD_INSTANCE_VALUE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">null</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oparg</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_PyDictOrValues_GetValues</span><span class="p">(</span><span class="n">dorv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="w">        </span><span class="n">DEOPT_IF</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">Py_INCREF</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">        </span><span class="n">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">macro</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">LOAD_ATTR_INSTANCE_VALUE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">counter</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CHECK_OBJECT_TYPE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CHECK_HAS_INSTANCE_VALUES</span><span class="w"> </span><span class="o">+</span>
<span class="w">        </span><span class="n">LOAD_INSTANCE_VALUE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">unused</span><span class="o">/</span><span class="mi">4</span><span class="w"> </span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">op</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">LOAD_SLOT</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">owner</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">null</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oparg</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">owner</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="w">        </span><span class="n">DEOPT_IF</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">Py_INCREF</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">        </span><span class="n">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">macro</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">LOAD_ATTR_SLOT</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">counter</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CHECK_OBJECT_TYPE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LOAD_SLOT</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">unused</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">inst</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">BUILD_TUPLE</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">oparg</span><span class="p">]</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">tuple</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_PyTuple_FromArraySteal</span><span class="p">(</span><span class="n">items</span><span class="p">,</span><span class="w"> </span><span class="n">oparg</span><span class="p">);</span>
<span class="w">        </span><span class="n">ERROR_IF</span><span class="p">(</span><span class="n">tuple</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">inst</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">PRINT_EXPR</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">POP</span><span class="p">();</span>
<span class="w">        </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">hook</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_PySys_GetAttr</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_Py_ID</span><span class="p">(</span><span class="n">displayhook</span><span class="p">));</span>
<span class="w">        </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hook</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">_PyErr_SetString</span><span class="p">(</span><span class="n">tstate</span><span class="p">,</span><span class="w"> </span><span class="n">PyExc_RuntimeError</span><span class="p">,</span>
<span class="w">                                </span><span class="s">&quot;lost sys.displayhook&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyObject_CallOneArg</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="n">ERROR_IF</span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="defining-an-instruction-family">
<h3>Defining an instruction family<a class="headerlink" href="#defining-an-instruction-family" title="Link to this heading">#</a></h3>
<p>A <em>family</em> maps a specializable instruction to its specializations.</p>
<p>Example: These opcodes all share the same instruction format):</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">family</span><span class="p">(</span><span class="n">load_attr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">LOAD_ATTR</span><span class="p">,</span><span class="w"> </span><span class="n">LOAD_ATTR_INSTANCE_VALUE</span><span class="p">,</span><span class="w"> </span><span class="n">LOAD_SLOT</span><span class="w"> </span><span class="p">};</span>
</pre></div>
</div>
</section>
<section id="defining-a-pseudo-instruction">
<h3>Defining a pseudo instruction<a class="headerlink" href="#defining-a-pseudo-instruction" title="Link to this heading">#</a></h3>
<p>A <em>pseudo instruction</em> is used by the bytecode compiler to represent a set of possible concrete instructions.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">JUMP</span></code> may expand to <code class="docutils literal notranslate"><span class="pre">JUMP_FORWARD</span></code> or <code class="docutils literal notranslate"><span class="pre">JUMP_BACKWARD</span></code>:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">pseudo</span><span class="p">(</span><span class="n">JUMP</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">JUMP_FORWARD</span><span class="p">,</span><span class="w"> </span><span class="n">JUMP_BACKWARD</span><span class="w"> </span><span class="p">};</span>
</pre></div>
</div>
</section>
</section>
<section id="generating-the-interpreter">
<h2>Generating the interpreter<a class="headerlink" href="#generating-the-interpreter" title="Link to this heading">#</a></h2>
<p>The generated C code for a single instruction includes a preamble and dispatch at the end
which can be easily inserted. What is more complex is ensuring the correct stack effects
and not generating excess pops and pushes.</p>
<p>For example, in <code class="docutils literal notranslate"><span class="pre">CHECK_HAS_INSTANCE_VALUES</span></code>, <code class="docutils literal notranslate"><span class="pre">owner</span></code> occurs in the input, so it cannot be
redefined. Thus it doesn’t need to written and can be read without adjusting the stack pointer.
The C code generated for <code class="docutils literal notranslate"><span class="pre">CHECK_HAS_INSTANCE_VALUES</span></code> would look something like:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_pointer</span><span class="p">[</span><span class="mi">-1</span><span class="p">];</span>
<span class="w">        </span><span class="n">PyDictOrValues</span><span class="w"> </span><span class="n">dorv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">_PyObject_DictOrValuesPointer</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="w">        </span><span class="n">DEOPT_IF</span><span class="p">(</span><span class="o">!</span><span class="n">_PyDictOrValues_IsValues</span><span class="p">(</span><span class="n">dorv</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>When combining ops together to form instructions, temporary values should be used,
rather than popping and pushing, such that <code class="docutils literal notranslate"><span class="pre">LOAD_ATTR_SLOT</span></code> would look something like:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">LOAD_ATTR_SLOT</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_pointer</span><span class="p">[</span><span class="mi">-1</span><span class="p">];</span>
<span class="w">        </span><span class="cm">/* CHECK_OBJECT_TYPE */</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span>
<span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">type_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read32</span><span class="p">(</span><span class="n">next_instr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="n">PyTypeObject</span><span class="w"> </span><span class="o">*</span><span class="n">tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Py_TYPE</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="w">            </span><span class="n">assert</span><span class="p">(</span><span class="n">type_version</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">tp_version_tag</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">type_version</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">deopt</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="cm">/* LOAD_SLOT */</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span>
<span class="w">            </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">next_instr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">            </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">owner</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">index</span><span class="p">;</span>
<span class="w">            </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">null</span><span class="p">;</span>
<span class="w">            </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">deopt</span><span class="p">;</span>
<span class="w">            </span><span class="n">Py_INCREF</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">            </span><span class="n">null</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">            </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">oparg</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">stack_pointer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">null</span><span class="p">;</span>
<span class="w">                </span><span class="n">stack_pointer</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">next_instr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">        </span><span class="n">stack_pointer</span><span class="p">[</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span>
<span class="w">        </span><span class="n">DISPATCH</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="other-tools">
<h2>Other tools<a class="headerlink" href="#other-tools" title="Link to this heading">#</a></h2>
<p>From the instruction definitions we can generate the stack marking code used in <code class="docutils literal notranslate"><span class="pre">frame.set_lineno()</span></code>,
and the tables for use by disassemblers.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./payloads/payload1/Python-3.13.0rc2/Tools/cases_generator"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#abstract">Abstract</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rationale">Rationale</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#specification">Specification</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#syntax">Syntax</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#special-instruction-annotations">Special instruction annotations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#special-functions-macros">Special functions/macros</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#semantics">Semantics</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#examples">Examples</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output-stack-effect">Output stack effect</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-stack-effect">Input stack effect</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#input-stack-effect-and-cache-effect">Input stack effect and cache effect</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#more-examples">More examples</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-an-instruction-family">Defining an instruction family</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-a-pseudo-instruction">Defining a pseudo instruction</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-the-interpreter">Generating the interpreter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#other-tools">Other tools</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Thibaut Cantaluppi
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>